# INTEGRIDAI MVP 2025 - NUEVA ARQUITECTURA
## Estructura de Desarrollo y Migraci√≥n desde Legacy

**Fecha:** 05 de junio de 2025  
**Proyecto:** IntegridAI - Compliance con IA  
**Fase:** Desarrollo MVP desde cero  
**Responsable:** Ignacio Adri√°n Lerer  

---

## 1. ESTRUCTURA DE ARCHIVOS PROPUESTA

```
IntegridAI-MCP-MVP-2025/
‚îú‚îÄ‚îÄ README.md                          # Documentaci√≥n principal
‚îú‚îÄ‚îÄ CHANGELOG.md                       # Historial de cambios
‚îú‚îÄ‚îÄ LICENSE                            # MIT/Propietaria
‚îú‚îÄ‚îÄ package.json                       # Dependencias y scripts
‚îú‚îÄ‚îÄ .gitignore                         # Exclusiones Git
‚îú‚îÄ‚îÄ .env.example                       # Variables de entorno template
‚îú‚îÄ‚îÄ 
‚îú‚îÄ‚îÄ src/                               # C√ìDIGO FUENTE PRINCIPAL
‚îÇ   ‚îú‚îÄ‚îÄ index.js                       # Entry point principal
‚îÇ   ‚îú‚îÄ‚îÄ server.js                      # Servidor MCP
‚îÇ   ‚îú‚îÄ‚îÄ 
‚îÇ   ‚îú‚îÄ‚îÄ core/                          # M√≥dulos core
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ iaOrchestrator.js          # Orquestador IA central
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ mcpHandler.js              # Manejador protocolo MCP
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ complianceEngine.js        # Motor an√°lisis compliance
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ scoringEngine.js           # Motor scoring Ley 27401
‚îÇ   ‚îÇ   
‚îÇ   ‚îú‚îÄ‚îÄ ai-integrations/               # Integraciones IA
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ openaiClient.js            # Cliente OpenAI
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ claudeClient.js            # Cliente Claude (Anthropic)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ aiRouter.js                # Router/balanceador IA
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ promptTemplates.js         # Templates de prompts
‚îÇ   ‚îÇ   
‚îÇ   ‚îú‚îÄ‚îÄ mcp-tools/                     # Herramientas MCP
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ complianceTools.js         # Tools compliance Ley 27401
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ scoringTools.js            # Tools scoring empresarial
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ reportingTools.js          # Tools reportes/auditor√≠a
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ validationTools.js         # Tools validaci√≥n datos
‚îÇ   ‚îÇ   
‚îÇ   ‚îú‚îÄ‚îÄ utils/                         # Utilidades
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ logger.js                  # Sistema logging
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ validators.js              # Validadores entrada
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ errorHandler.js            # Manejo errores
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ helpers.js                 # Funciones auxiliares
‚îÇ   ‚îÇ   
‚îÇ   ‚îî‚îÄ‚îÄ api/                           # Endpoints API (opcional)
‚îÇ       ‚îú‚îÄ‚îÄ routes.js                  # Rutas principales
‚îÇ       ‚îú‚îÄ‚îÄ middleware.js              # Middlewares
‚îÇ       ‚îî‚îÄ‚îÄ controllers.js             # Controladores
‚îÇ       
‚îú‚îÄ‚îÄ config/                            # CONFIGURACIONES
‚îÇ   ‚îú‚îÄ‚îÄ default.json                   # Config por defecto
‚îÇ   ‚îú‚îÄ‚îÄ development.json               # Config desarrollo
‚îÇ   ‚îú‚îÄ‚îÄ production.json                # Config producci√≥n
‚îÇ   ‚îú‚îÄ‚îÄ scoringRules.json              # Reglas scoring Ley 27401
‚îÇ   ‚îú‚îÄ‚îÄ complianceMatrix.json          # Matriz compliance
‚îÇ   ‚îî‚îÄ‚îÄ aiProviders.json               # Config proveedores IA
‚îÇ   
‚îú‚îÄ‚îÄ tests/                             # TESTING
‚îÇ   ‚îú‚îÄ‚îÄ unit/                          # Tests unitarios
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ core/                      # Tests m√≥dulos core
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ai-integrations/           # Tests IA
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ mcp-tools/                 # Tests herramientas MCP
‚îÇ   ‚îú‚îÄ‚îÄ integration/                   # Tests integraci√≥n
‚îÇ   ‚îú‚îÄ‚îÄ fixtures/                      # Datos de prueba
‚îÇ   ‚îî‚îÄ‚îÄ setup.js                       # Setup testing
‚îÇ   
‚îú‚îÄ‚îÄ docs/                              # DOCUMENTACI√ìN
‚îÇ   ‚îú‚îÄ‚îÄ API.md                         # Documentaci√≥n API
‚îÇ   ‚îú‚îÄ‚îÄ MCP_PROTOCOL.md                # Documentaci√≥n protocolo MCP
‚îÇ   ‚îú‚îÄ‚îÄ COMPLIANCE.md                  # Gu√≠a compliance
‚îÇ   ‚îú‚îÄ‚îÄ DEPLOYMENT.md                  # Gu√≠a despliegue
‚îÇ   ‚îî‚îÄ‚îÄ LEGAL.md                       # Aspectos legales DNDA
‚îÇ   
‚îú‚îÄ‚îÄ scripts/                           # SCRIPTS AUTOMATIZACI√ìN
‚îÇ   ‚îú‚îÄ‚îÄ build.js                       # Script build
‚îÇ   ‚îú‚îÄ‚îÄ deploy.js                      # Script despliegue
‚îÇ   ‚îú‚îÄ‚îÄ validate-compliance.js         # Validaci√≥n compliance
‚îÇ   ‚îî‚îÄ‚îÄ generate-docs.js               # Generaci√≥n documentaci√≥n
‚îÇ   
‚îî‚îÄ‚îÄ legacy-rescue/                     # MATERIAL LEGACY (YA MIGRADO)
    ‚îú‚îÄ‚îÄ README.md                      # Inventario legacy
    ‚îî‚îÄ‚îÄ [archivos legacy organizados]
```

---

## 2. AN√ÅLISIS MIGRACI√ìN VS REESCRITURA

### üü¢ MIGRAR (C√≥digo Validado)

#### **Base de Conocimiento Ley 27401** ‚Üí `config/scoringRules.json`
**Archivo origen:** `mcp_ley27401_server_v4.2_FIXED.cjs`
**Justificaci√≥n:** Base de datos completa y validada
```javascript
// MIGRAR: LEY_27401_DB completa
{
  "elementos_programa_integridad": [...],
  "delitos_ley27401": [...],
  "factores_riesgo": [...],
  "industrias_alto_riesgo": [...]
}
```

#### **L√≥gica de Scoring** ‚Üí `src/core/scoringEngine.js`
**Archivo origen:** Funci√≥n `analizarCumplimiento()` de v4.2
**Justificaci√≥n:** Algoritmo probado y funcional

#### **Esquemas MCP Tools** ‚Üí `src/mcp-tools/complianceTools.js`
**Archivo origen:** Definiciones `tools[]` de v4.2
**Justificaci√≥n:** Esquemas validados con Claude Desktop

### üü° REESCRIBIR (Arquitectura Mejorada)

#### **Servidor MCP** ‚Üí `src/server.js` + `src/core/mcpHandler.js`
**Justificaci√≥n:** 
- Separar protocolo de l√≥gica de negocio
- Implementar modularidad y testing
- Corregir problemas de streams identificados

#### **Orquestador IA** ‚Üí `src/core/iaOrchestrator.js`
**Justificaci√≥n:**
- Integrar m√∫ltiples proveedores IA
- Implementar failover y load balancing
- A√±adir caching y optimizaci√≥n

### üî¥ DESCARTAR (Problem√°tico)

#### **mcp_integridai_FIXED.cjs**
**Justificaci√≥n:** Problemas de conectividad irreparables

#### **Versiones experimentales**
**Justificaci√≥n:** No est√°n production-ready

---

## 3. TEMPLATES DE ARCHIVOS BASE

### **package.json**
```json
{
  "name": "integridai-mcp-mvp",
  "version": "1.0.0",
  "description": "IntegridAI - Compliance empresarial con IA y protocolo MCP",
  "main": "src/index.js",
  "type": "module",
  "scripts": {
    "start": "node src/index.js",
    "dev": "nodemon src/index.js",
    "test": "jest",
    "test:watch": "jest --watch",
    "build": "node scripts/build.js",
    "lint": "eslint src/",
    "validate": "node scripts/validate-compliance.js"
  },
  "dependencies": {
    "@anthropic-ai/sdk": "^0.24.3",
    "openai": "^4.52.7",
    "zod": "^3.23.8",
    "winston": "^3.13.0",
    "dotenv": "^16.4.5",
    "express": "^4.19.2"
  },
  "devDependencies": {
    "jest": "^29.7.0",
    "nodemon": "^3.1.4",
    "eslint": "^9.5.0"
  },
  "author": "Ignacio Adri√°n Lerer",
  "license": "PROPRIETARY",
  "copyright": "¬© 2025 IntegridAI - Todos los derechos reservados"
}
```

### **src/index.js** (Entry Point)
```javascript
#!/usr/bin/env node
/**
 * IntegridAI MVP 2025 - Entry Point
 * ¬© 2025 IntegridAI - Ignacio Adri√°n Lerer
 */

import { config } from 'dotenv';
import { logger } from './utils/logger.js';
import { MCPServer } from './server.js';
import { IAOrchestrator } from './core/iaOrchestrator.js';

// Cargar configuraci√≥n
config();

async function startIntegridAI() {
  try {
    logger.info('üöÄ Iniciando IntegridAI MVP 2025...');
    
    // Inicializar componentes
    const iaOrchestrator = new IAOrchestrator();
    await iaOrchestrator.initialize();
    
    const mcpServer = new MCPServer(iaOrchestrator);
    await mcpServer.start();
    
    logger.info('‚úÖ IntegridAI MVP iniciado correctamente');
    logger.info(`üìä Protocolo MCP activo en proceso ${process.pid}`);
    
  } catch (error) {
    logger.error('‚ùå Error iniciando IntegridAI:', error);
    process.exit(1);
  }
}

// Manejo de se√±ales
process.on('SIGINT', async () => {
  logger.info('üîÑ Cerrando IntegridAI MVP...');
  process.exit(0);
});

process.on('SIGTERM', async () => {
  logger.info('üîÑ Cerrando IntegridAI MVP...');
  process.exit(0);
});

// Iniciar aplicaci√≥n
startIntegridAI();
```

### **src/core/iaOrchestrator.js**
```javascript
/**
 * IntegridAI - Orquestador de IA
 * Maneja m√∫ltiples proveedores IA con failover
 */

import { OpenAIClient } from '../ai-integrations/openaiClient.js';
import { ClaudeClient } from '../ai-integrations/claudeClient.js';
import { logger } from '../utils/logger.js';

export class IAOrchestrator {
  constructor() {
    this.providers = new Map();
    this.currentProvider = null;
    this.failoverQueue = [];
  }

  async initialize() {
    try {
      // Inicializar proveedores IA
      this.providers.set('openai', new OpenAIClient());
      this.providers.set('claude', new ClaudeClient());
      
      // Configurar prioridades
      this.failoverQueue = ['claude', 'openai'];
      this.currentProvider = this.failoverQueue[0];
      
      logger.info('ü§ñ Orquestador IA inicializado');
      logger.info(`üéØ Proveedor principal: ${this.currentProvider}`);
      
    } catch (error) {
      logger.error('‚ùå Error inicializando orquestador IA:', error);
      throw error;
    }
  }

  async processComplianceAnalysis(texto, empresa, industria) {
    const prompt = this.buildCompliancePrompt(texto, empresa, industria);
    
    for (const providerName of this.failoverQueue) {
      try {
        const provider = this.providers.get(providerName);
        const result = await provider.analyze(prompt);
        
        logger.info(`‚úÖ An√°lisis completado con ${providerName}`);
        return result;
        
      } catch (error) {
        logger.warn(`‚ö†Ô∏è Fallo en ${providerName}, intentando siguiente...`);
        continue;
      }
    }
    
    throw new Error('Todos los proveedores IA fallaron');
  }

  buildCompliancePrompt(texto, empresa, industria) {
    return {
      role: 'system',
      content: `Analiza el siguiente texto empresarial para cumplimiento de Ley 27401...`,
      data: { texto, empresa, industria }
    };
  }
}
```

### **config/scoringRules.json** (Migrado desde Legacy)
```json
{
  "version": "1.0.0",
  "ley27401": {
    "elementos_programa_integridad": [
      {
        "id": "codigo_etica",
        "keyword": "c√≥digo de √©tica",
        "peso": 15,
        "descripcion": "Conjunto de principios y valores organizacionales",
        "categoria": "documentacion"
      },
      {
        "id": "capacitacion",
        "keyword": "capacitaci√≥n",
        "peso": 12,
        "descripcion": "Entrenamiento en integridad y compliance",
        "categoria": "formacion"
      },
      {
        "id": "canal_denuncias",
        "keyword": "canal de denuncias",
        "peso": 18,
        "descripcion": "Mecanismo seguro para reportar irregularidades",
        "categoria": "control"
      }
    ],
    "scoring": {
      "excelente": { "min": 80, "max": 100, "color": "verde" },
      "bueno": { "min": 60, "max": 79, "color": "amarillo" },
      "regular": { "min": 40, "max": 59, "color": "naranja" },
      "insuficiente": { "min": 0, "max": 39, "color": "rojo" }
    }
  }
}
```

### **tests/unit/core/scoringEngine.test.js**
```javascript
/**
 * Tests Unitarios - Scoring Engine
 */

import { describe, test, expect, beforeEach } from '@jest/globals';
import { ScoringEngine } from '../../../src/core/scoringEngine.js';

describe('ScoringEngine', () => {
  let scoringEngine;

  beforeEach(() => {
    scoringEngine = new ScoringEngine();
  });

  test('deber√≠a analizar texto con c√≥digo de √©tica', () => {
    const texto = 'Nuestra empresa tiene un c√≥digo de √©tica robusto';
    const result = scoringEngine.analyze(texto);
    
    expect(result.score).toBeGreaterThan(0);
    expect(result.elementos_detectados).toContain('c√≥digo de √©tica');
  });

  test('deber√≠a retornar score 0 para texto sin elementos', () => {
    const texto = 'Texto sin elementos de compliance';
    const result = scoringEngine.analyze(texto);
    
    expect(result.score).toBe(0);
    expect(result.nivel).toBe('INSUFICIENTE');
  });
});
```

---

## 4. PROCEDIMIENTOS TESTING Y CI/CD

### **Testing Strategy**

#### **Nivel 1: Tests Unitarios**
```bash
# Ejecutar tests unitarios
npm test

# Coverage m√≠nimo requerido: 80%
npm run test:coverage
```

#### **Nivel 2: Tests Integraci√≥n**
```bash
# Test integraci√≥n con IA providers
npm run test:integration

# Test protocolo MCP end-to-end
npm run test:mcp
```

#### **Nivel 3: Tests Compliance**
```bash
# Validar reglas de scoring
npm run validate:scoring

# Test casos reales empresariales
npm run test:compliance
```

### **CI/CD Pipeline**

#### **.github/workflows/main.yml**
```yaml
name: IntegridAI CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - run: npm ci
      - run: npm test
      - run: npm run validate:compliance
      
  security:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: npm audit
      - run: npm run lint
```

---

## 5. COMPLIANCE LEGAL/T√âCNICO

### **Pre-commit Hooks**

#### **.pre-commit-config.yaml**
```yaml
repos:
  - repo: local
    hooks:
      - id: copyright-check
        name: Verificar copyright IntegridAI
        entry: scripts/check-copyright.js
        language: node
        
      - id: compliance-validation
        name: Validar reglas compliance
        entry: scripts/validate-compliance.js
        language: node
```

### **Checklist Push Relevante**

#### **scripts/compliance-checklist.md**
```markdown
## Checklist Compliance - Push Relevante

- [ ] **Copyright actualizado** en archivos nuevos/modificados
- [ ] **Tests unitarios** cubren nueva funcionalidad
- [ ] **Documentaci√≥n** actualizada en `/docs/`
- [ ] **CHANGELOG.md** incluye cambios relevantes
- [ ] **Scoring rules** validadas contra casos test
- [ ] **Configuraci√≥n** no expone secrets/tokens
- [ ] **Logs** no contienen informaci√≥n sensible
- [ ] **Versi√≥n** actualizada en package.json (si corresponde)

### Validaci√≥n Legal DNDA:
- [ ] C√≥digo es 100% original o migrado desde legacy propio
- [ ] No hay dependencias con licencias incompatibles
- [ ] Headers de copyright presentes y correctos
```

### **Documentaci√≥n Continua**

#### **scripts/generate-docs.js**
```javascript
/**
 * Generador autom√°tico de documentaci√≥n
 * Se ejecuta en cada push a main
 */

import fs from 'fs';
import path from 'path';

// Generar API docs desde JSDoc
// Actualizar README con estad√≠sticas
// Validar links y referencias
// Crear changelog autom√°tico desde commits
```

---

## 6. CRONOGRAMA DE IMPLEMENTACI√ìN

### **Semana 1: Base Architecture**
- [ ] Estructura de directorios
- [ ] Package.json y dependencias
- [ ] Entry point y servidor MCP b√°sico
- [ ] Tests unitarios setup

### **Semana 2: Core Modules**
- [ ] Migrar scoring engine desde legacy
- [ ] Implementar orquestador IA
- [ ] Configurar proveedores IA
- [ ] Tests integraci√≥n b√°sicos

### **Semana 3: MCP Tools**
- [ ] Migrar herramientas MCP validadas
- [ ] Implementar nuevas tools
- [ ] Documentaci√≥n API completa
- [ ] CI/CD pipeline

### **Semana 4: Polish & Deploy**
- [ ] Compliance final validation
- [ ] Performance optimization
- [ ] Security audit
- [ ] Documentaci√≥n legal DNDA

---

## 7. M√âTRICAS DE √âXITO

### **T√©cnicas**
- ‚úÖ Tests coverage > 80%
- ‚úÖ Response time < 500ms
- ‚úÖ Zero security vulnerabilities
- ‚úÖ MCP protocol 100% compliant

### **Legales**
- ‚úÖ Copyright en 100% archivos
- ‚úÖ Documentaci√≥n DNDA completa
- ‚úÖ Trazabilidad de c√≥digo fuente
- ‚úÖ Compliance checklist automatizado

### **Funcionales**
- ‚úÖ An√°lisis Ley 27401 funcional
- ‚úÖ Integraci√≥n multi-IA estable
- ‚úÖ Scoring preciso y documentado
- ‚úÖ Reportes auditables

---

**NOTA:** Esta arquitectura garantiza modularidad, testabilidad, compliance legal y escalabilidad para el crecimiento futuro de IntegridAI.